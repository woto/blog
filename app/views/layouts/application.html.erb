<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

    <head>
      <title><%= h(yield(:title) || "Untitled") %></title>
      <%= stylesheet_link_tag 'application', 'formtastic', 'formtastic_changes', 'weakling', :cache => true, :concat => true %>
      <%= sprockets_include_tag %>
      <%= javascript_include_tag :ckeditor %>
      <%= calendar_date_select_includes :style => "default", :locale => "ru" %>

      <%= yield(:head) %>

      <meta http-equiv="content-type" content="text/html; charset=utf-8" />
      <meta name="keywords" content="" />
      <meta name="description" content="" />
</head>
<body>

<div id="header">

	<div id="header_inner" class="fixed">

		<div id="logo">
      <a href="/">
        <h1><span>Персональный сайт</span></h1>
			  <h2>(в процессе разработки)</h2>
      </a>
		</div>
		
		<div id="menu">
			<ul>
				<li><a href="#">Главная</a></li>
				<li><a href="#" class="active">Обо мне</a></li>
				<li><a href="#">Обратная связь</a></li>
			</ul>
		</div>
		
	</div>
</div>

<div id="main">

	<div id="main_inner" class="fixed">

		<div id="primaryContent_3columns">

			<div id="columnA_3columns">
        
        <%- flash.each do |name, msg| -%>
          <%= content_tag :div, msg, :id => "flash_#{name}" %>
        <%- end -%>

        <%- if show_title? -%>
          <h1><%=h yield(:title) %></h1>
        <%- end -%>
      
      <% if params[:category] || params[:tags] || params[:date] %>
        <div id="filter">
            <% if params[:category] and category = Category.find_by_name(params[:category]) %>
              <p>
                Просмотр происходит внутри категории: 
                (
                <% category.self_and_ancestors.each do |item| %>
                  <%= link_to(item.name, search_posts_path(:date => params[:date], :tags => params[:tags], :category => item.name)) %>
                  <%= " → " unless category.self_and_ancestors.last == item %>
                <% end %>
                )
                <%= link_to "<sup>x</sup>", search_posts_path(:date => params[:date], :tags => params[:tags]) %>
              </p>
            <% end %>
            <% if params[:tags] %>
              <p>
                <% tags = Array.[](params[:tags]).flatten %>
                Включен фильтр по  <%= Russian.p(tags.count, "тегу", "тегам", "тегам") %>:
                <% tags.each { |tag| %>
                ( <%= link_to h(tag), search_posts_path(:date => params[:date], :tags => tag, :category => params[:category]) %> )
                <%= link_to "<sup>x</sup>", search_posts_path(:date => params[:date], :tags => tags.reject{|item| item == tag}, :category => params[:category]) %>
                <% } %>
              </p>
            <% end %>
            <% if params[:date] %>
              <p>
                Включен фильтр по дате:
                (
                <% if params[:date] =~ /^\d+-\d+-00$/ %>
                  <%= Russian.strftime(@date, "%B %Y") %>
                <% elsif params[:date] =~ /^\d+-\d+-\d+$/ %>
                  <%= Russian.strftime(@date, "%d %B %Y") %>
                <% end %>
                )
                <%= link_to "<sup>x</sup>", search_posts_path(:tags => params[:tags], :category => params[:category]) %>
              </p>
            <% end %>
            <p>
              Внимание, при листании календаря действие всех фильтров кроме фильтра по дате сохраняется, <%= link_to "вы можете сбросить все фильтры", search_posts_path %></a>.
            </p>
        </div>

        <br class="clear" />

			<% end %>
  	
        <%= yield %>
		
			</div>
	
		</div>
		
		<div id="secondaryContent_3columns">
		
      <div id="columnB_3columns">

        <h4><span>Категории</span> постов</h4>
        <div class="block">
          <% cat = Category.find_by_sql('select c2.name, c2.id, count(*) as lvl from categories as c1, categories as c2 where c2.lft between c1.lft and c1.rgt group by c2.name order by c2.lft') %>
          <ul class="links">
            <% counter = 0 %>
            <% cat.each_with_index do |c, i| %>

              <% if !cat[i+1].nil? && cat[i+1].lvl.to_i > c.lvl.to_i %>
                <% counter += 1 %>
                <li><%= link_to(c.name, search_posts_path(:date => params[:date], :tags => params[:tags], :category => c.name)) %><ul class="links">
              <% end %>

              <% if !cat[i+1].nil? && cat[i+1].lvl.to_i == c.lvl.to_i %>
                <li><%= link_to(c.name, search_posts_path(:date => params[:date], :tags => params[:tags], :category => c.name)) %></li>
              <% end %>

              <% if !cat[i+1].nil? && cat[i+1].lvl.to_i < c.lvl.to_i %>
                <li><%= link_to(c.name, search_posts_path(:date => params[:date], :tags => params[:tags], :category => c.name)) %></li>
                <% counter -= 1 %>
                <% (c.lvl.to_i - cat[i+1].lvl.to_i).times do %>
                    </ul></li>
                <% end %>
              <% end %>
              
              <% if (cat[i+1].nil?) %>
                <li><%= link_to(c.name, search_posts_path(:date => params[:date], :tags => params[:tags], :category => c.name)) %></li>
                <% counter.times do %>
                  </ul></li>
                <% end %>
              <% end %>

            <% end %>
          </ul>
        </div>
        
        <h4><span>Родственные</span> теги</h4>
        <div class="block">
          <%= render(:partial => "related_tags", :collection => @tags, :as => :tag) %>
        </div>
        
        <h4><span>Календарь</span> публикаций</h4>
        <%=  render :partial => 'shared/calendar', :object => @calendar_posts %>

        <h4><span>Временные</span> ссылки</h4>
        <div class="block">
          <ul class="links">
            <li><%= link_to "Вход", login_path %></li>
            <li><%= link_to "Регистрация", register_path %></li>
            <br />
            <li><%= link_to "Просмотр профиля", user_path %></li>
            <li><%= link_to "Выход", logout_path %></li>
            <li><%= link_to "Редактирование профиля", edit_user_path %></li>
            <li><%= link_to "Удалить аккаунт", user_path, :confirm => "Вы действительно хотите удалить свой аккаунт?", :method => :delete %></li>
            <br />
            <li><%= link_to "Создать категорию", new_category_path %></li>
            <li><%= link_to "Написать пост", new_post_path %></li>
            <li><%= link_to "Тест каптчи", new_captcha_test_path %></li>
            <br />
            <li> Роль: <%= begin current_user.roles.first.name rescue "не аутентифицирован" end %>
          </ul>
        </div>

 			</div>
			
      <div id="columnC_3columns">
  
        <h4><span>Поиск</span></h4>

        <div class="block">
          <form method="post" action="">
          <div id="search">
            <input type="text" class="text" name="keywords" />
            <input type="submit" class="button" value="Ок" />
            <br class="clear" />
          </div>
          </form>
        </div>


        <h4><span>Обо</span> мне</h4>
        <div class="block">
          <div style="text-align: center">
            <img width="120" height="160" src="http://farm4.static.flickr.com/3539/4567817472_f107697a88_o.jpg" alt="Корнев Руслан aka woto" />
          </div>
          <br style="clear" />
          Разрешите представиться, я, Корнев Руслан aka woto. Веб программист, занимаюсь разработкой сайтов на Ruby on Rails и PHP. Стараюсь делать интересные, в меру уникальные сайты, ищу работу. Подробнее на странице <a href="">Обо мне...</a>
        </div>

        <h4><span>Я в других</span> местах</h4>
        <div class="block">
          <ul class="links">
            <li><a href="http://hh.ru/resume/472e8180008173f5">Head Hunter </a></li>
            <li><a href="http://kornevruslan.moikrug.ru/">Мой Круг</a></li>
            <li><a href="http://www.twitter.com/woto7">Twitter</a></li>
            <li><a href="http://delicious.com/woto">Delicious</a></li>
            <li><a href="http://www.youtube.com/user/wotok7">Youtube</a></li>
            <li><a href="http://woto7.blogspot.com/">Blogspot</a</li>
            <li><a href="http://vimeo.com/woto">Vimeo</a></li>
            <li><a href="http://www.flickr.com/photos/48576382@N06/">Flickr</a></li>
            <li><a href="http://github.com/woto">Github</a></li>
            <li><a href="http://www.google.com/profiles/107009283623209618815">Google Buzz</a></li>
            <li><a href="http://www.google.com/reader/shared/03958211105266633351">Google Reader</a></li>
            <li><a href="http://friendfeed.com/woto">Friend Feed</a></li>
            <li><a href="http://www.facebook.com/profile.php?id=100000295528262">Facebook</a></li>
          </ul>
        </div>

			</div>

		</div>

		<br class="clear" />

	</div>

</div>

<div id="footer" class="fixed">
  Дизайн от <a href="http://www.nodethirtythree.com">nodethirtythree</a> и <a href="http://www.freecsstemplates.org">Free CSS Templates</a>.
</div>

</body>
</html>
